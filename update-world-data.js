import fs from 'fs/promises';

// --- CONFIGURATION ---
// The same GeoJSON URL your GlobeComponent uses (ensures name matching)
const GEOJSON_URL = 'https://raw.githubusercontent.com/vasturiano/react-globe.gl/master/example/datasets/ne_110m_admin_0_countries.geojson';

// World Bank API Base
const WB_BASE = "http://api.worldbank.org/v2/country";

// --- HELPER FUNCTIONS ---

// 1. Fetch Hard Data from World Bank
async function fetchCountryStats(iso3) {
    // GDP (NY.GDP.MKTP.CD), Pop (SP.POP.TOTL), Growth (NY.GDP.MKTP.KD.ZG)
    const url = `${WB_BASE}/${iso3}/indicator/NY.GDP.MKTP.CD;SP.POP.TOTL;NY.GDP.MKTP.KD.ZG?source=2&format=json&per_page=1&date=2022`;

    try {
        const res = await fetch(url);
        const data = await res.json();

        // World Bank returns an array: [metadata, [indicator1, indicator2...]]
        // But multi-indicator fetch is tricky, let's do parallel single fetches for reliability
        const [gdpRes, popRes, growthRes] = await Promise.all([
            fetch(`${WB_BASE}/${iso3}/indicator/NY.GDP.MKTP.CD?format=json&date=2022`).then(r => r.json()),
            fetch(`${WB_BASE}/${iso3}/indicator/SP.POP.TOTL?format=json&date=2022`).then(r => r.json()),
            fetch(`${WB_BASE}/${iso3}/indicator/NY.GDP.MKTP.KD.ZG?format=json&date=2022`).then(r => r.json())
        ]);

        const getVal = (res) => res[1]?.[0]?.value || 0;

        const gdp = getVal(gdpRes);
        const pop = getVal(popRes);
        const growth = getVal(growthRes);

        return {
            gdpRaw: gdp,
            popRaw: pop,
            growthRaw: growth,
            formatted: {
                // Convert to Trillions/Billions for Sci-Fi UI
                gdp: gdp > 1e12 ? `$${(gdp / 1e12).toFixed(1)}T` : `$${(gdp / 1e9).toFixed(1)}B`,
                population: pop > 1e9 ? `${(pop / 1e9).toFixed(2)}B` : `${(pop / 1e6).toFixed(1)}M`,
                growth: `${growth > 0 ? '+' : ''}${growth.toFixed(1)}%`
            }
        };

    } catch (e) {
        console.warn(`âš ï¸ Failed to fetch WB data for ${iso3}:`, e.message);
        return null;
    }
}

// 2. Generate "Soft" Intelligence (The AI Agent Placeholder)
function generateIntelligence(countryName, stats) {
    // In the future, this is where you call OpenAI/Gemini API

    // Heuristic: High growth + Low GDP = Emerging/Medium Risk
    // Heuristic: Low growth + High GDP = Stable/Low Risk
    let risk = "Medium";
    if (stats.growthRaw > 4) risk = "High"; // "Volatile"
    if (stats.gdpRaw > 2e12 && stats.growthRaw > 0) risk = "Low"; // "Established"

    // Deterministic "Random" Segments based on name length (so it doesn't change on re-render)
    const seed = countryName.length;

    return {
        activeUsers: Math.floor((stats.popRaw / 100) / 1000000) + "M", // Approx 1% of pop
        risk: risk,
        segments: [
            { name: "Cybernetics", value: 30 + (seed % 20) },
            { name: "Bio-Tech", value: 20 + (seed % 10) },
            { name: "Off-World", value: 100 - (50 + (seed % 30)) }
        ]
    };
}

// --- MAIN EXECUTION ---

async function main() {
    console.log("ðŸ”µ SYSTEM INITIALIZED: ORBIS DATA ENGINE");
    console.log("ðŸ“¡ Connecting to Geo-Satellites (Fetching GeoJSON)...");

    // 1. Get the Master List from GeoJSON
    const geoRes = await fetch(GEOJSON_URL);
    const geoData = await geoRes.json();

    console.log(`âœ… Uplink Established. Found ${geoData.features.length} regions.`);

    const outputData = {};
    let successCount = 0;

    // 2. Iterate and Enrich
    for (const feature of geoData.features) {
        const name = feature.properties.NAME; // Matches Globe Click
        const iso3 = feature.properties.ISO_A3; // Matches World Bank
        const iso2 = feature.properties.ISO_A2;

        // Skip if not in our target list (Remove this check to run ALL countries)
        // Limit removed - processing all countries

        process.stdout.write(`   Processing ${iso3} (${name})... `);

        const wbStats = await fetchCountryStats(iso3);

        if (wbStats) {
            const intelligence = generateIntelligence(name, wbStats);

            outputData[name] = {
                name: name,
                code: iso2,
                ...wbStats.formatted,
                ...intelligence
            };
            console.log("OK");
            successCount++;
        } else {
            console.log("FAILED");
        }
    }

    // 3. Write to File
    const fileContent = `// AUTO-GENERATED BY ORBIS DATA ENGINE
// DO NOT EDIT MANUALLY
export const countryData = ${JSON.stringify(outputData, null, 4)};`;

    await fs.writeFile('./src/data/mockData.js', fileContent);

    console.log("\nðŸŸ¢ SEQUENCE COMPLETE.");
    console.log(`   Updated records for ${successCount} sectors.`);
    console.log("   Target: src/data/mockData.js");
}

main();
